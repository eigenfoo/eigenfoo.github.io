<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://www.georgeho.org/favicon.ico><title>Streaming Data with Tornado and WebSockets | George Ho</title><meta name=title content="Streaming Data with Tornado and WebSockets"><meta name=description content="A lot of data science and machine learning practice assumes a static dataset, maybe with some MLOps tooling for rerunning a model pipeline with the freshest version of the dataset.
Working with streaming data is an entirely different ball game, and it wasn&rsquo;t clear to me what tools a data scientist might reach for when dealing with streaming data1.
I recently came across a pretty straightforward and robust solution: WebSockets and Tornado."><meta name=keywords content="python,streaming,"><meta property="og:title" content="Streaming Data with Tornado and WebSockets"><meta property="og:description" content="A lot of data science and machine learning practice assumes a static dataset, maybe with some MLOps tooling for rerunning a model pipeline with the freshest version of the dataset.
Working with streaming data is an entirely different ball game, and it wasn&rsquo;t clear to me what tools a data scientist might reach for when dealing with streaming data1.
I recently came across a pretty straightforward and robust solution: WebSockets and Tornado."><meta property="og:type" content="article"><meta property="og:url" content="https://www.georgeho.org/tornado-websockets/"><meta property="og:image" content="https://www.georgeho.org/assets/images/asterism.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-05T00:00:00+00:00"><meta property="og:site_name" content="⁂ George Ho"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.georgeho.org/assets/images/asterism.png"><meta name=twitter:title content="Streaming Data with Tornado and WebSockets"><meta name=twitter:description content="A lot of data science and machine learning practice assumes a static dataset, maybe with some MLOps tooling for rerunning a model pipeline with the freshest version of the dataset.
Working with streaming data is an entirely different ball game, and it wasn&rsquo;t clear to me what tools a data scientist might reach for when dealing with streaming data1.
I recently came across a pretty straightforward and robust solution: WebSockets and Tornado."><meta itemprop=name content="Streaming Data with Tornado and WebSockets"><meta itemprop=description content="A lot of data science and machine learning practice assumes a static dataset, maybe with some MLOps tooling for rerunning a model pipeline with the freshest version of the dataset.
Working with streaming data is an entirely different ball game, and it wasn&rsquo;t clear to me what tools a data scientist might reach for when dealing with streaming data1.
I recently came across a pretty straightforward and robust solution: WebSockets and Tornado."><meta itemprop=datePublished content="2021-10-05T00:00:00+00:00"><meta itemprop=dateModified content="2021-10-05T00:00:00+00:00"><meta itemprop=wordCount content="1498"><meta itemprop=image content="https://www.georgeho.org/assets/images/asterism.png"><meta itemprop=keywords content="python,streaming,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>
  MathJax.Hub.Config({ tex2jax: {inlineMath: [["$", "$"]]} })
</script><script async src=//static.getclicky.com/101349618.js></script><noscript><p><img alt=Clicky width=1 height=1 src=//in.getclicky.com/101349618ns.gif></p></noscript><link rel=stylesheet media=all href=/assets/fonts/nicholson-gothic.css type=text/css><link rel=stylesheet media=all href=/assets/fonts/triplicate-a.css type=text/css><script type=text/javascript>navigator.appVersion.indexOf("Win")!=-1?document.write('<link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-a.css"/>'):navigator.appVersion.indexOf("Mac")!=-1?navigator.userAgent.match(/iPad/i)!=null?(document.write('<link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="/assets/fonts/equity-b.css" type="text/css"/>'),document.write('<link rel="stylesheet" media="only screen and (min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2)" type="text/css" href="/assets/fonts/equity-a.css"/>')):document.write('<link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-b.css"/>'):document.write('<link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-a.css"/>')</script><style>html{font-size:18px;font-size:min(max(1rem,4vw),22px)}body{font-family:Equity,Georgia,serif;background-color:#fffff8}code{font-family:Triplicate,lucida console,monospace;font-size:75%}pre code{white-space:pre;overflow-x:scroll;-webkit-overflow-scrolling:touch;font-size:13px;font-size:min(max(12px,2vw),14px)}h1,h2,h3,h4,h5,h6{font-family:NicholsonGothic,Verdana,sans-serif}@media(prefers-color-scheme:dark){body{background-color:#111}}</style></head><body><header><a href=/ class=title><h2>⁂ George Ho</h2></a><nav><a href=/>Home</a>
<a href=/work/>Work</a>
<a href=/blog>Blog</a></nav></header><main><h1>Streaming Data with Tornado and WebSockets</h1><p><i><time datetime=2021-10-05 pubdate>2021-10-05</time></i></p><content><p>A lot of data science and machine learning practice assumes a static dataset,
maybe with some MLOps tooling for rerunning a model pipeline with the freshest
version of the dataset.</p><p>Working with streaming data is an entirely different ball game, and it wasn&rsquo;t
clear to me what tools a data scientist might reach for when dealing with
streaming data<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>I recently came across a pretty straightforward and robust solution:
<a href=https://datatracker.ietf.org/doc/html/rfc6455>WebSockets</a> and
<a href=https://www.tornadoweb.org/en/stable/>Tornado</a>. Tornado is a Python web
framework with strong support for asynchronous networking. WebSockets are a
way for two processes (or apps) to communicate with each other (similar to HTTP
requests with REST endpoints). Of course, Tornado has pretty good support for
WebSockets as well.</p><p>In this blog post I&rsquo;ll give a minimal example of using Tornado and WebSockets
to handle streaming data. The toy example I have is one app (<code>server.py</code>)
writing samples of a Bernoulli to a WebSocket, and another app (<code>client.py</code>)
listening to the WebSocket and keeping track of the posterior distribution for
a <a href=https://www.georgeho.org/bayesian-bandits/>Beta-Binomial conjugate model</a>.
After walking through the code, I&rsquo;ll discuss these tools, and why they&rsquo;re good
choices for working with streaming data.</p><p>For another tutorial on this same topic, you can check out <a href=https://en.proft.me/2014/05/16/realtime-web-application-tornado-and-websocket/><code>proft</code>&rsquo;s blog
post</a>.</p><h2 id=server>Server</h2><ul><li>When <code>WebSocketServer</code> is registered to a REST endpoint (in <code>main</code>), it keeps
track of any processes who are listening to that endpoint, and pushes
messages to them when <code>send_message</code> is called.<ul><li>Note that <code>clients</code> is a class variable, so <code>send_message</code> is a class
method.</li><li>This class could be extended to also listen to the endpoint, instead of
just blindly pushing messages out &mdash; after all, WebSockets allow for
bidirectional data flow.</li></ul></li><li>The <code>RandomBernoulli</code> and <code>PeriodicCallback</code> make a pretty crude example, but
you could write a class that transmits data in real-time to suit your use
case. For example, you could watch a file for any modifications using
<a href=https://pythonhosted.org/watchdog/><code>watchdog</code></a>, and dump the changes into
the WebSocket.</li><li>The <a href="https://www.tornadoweb.org/en/stable/web.html?highlight=websocket_ping#tornado.web.Application.settings"><code>websocket_ping_interval</code> and <code>websocket_ping_timeout</code> arguments to
<code>tornado.Application</code></a>
configure periodic pings of WebSocket connections, keeping connections alive
and allowing dropped connections to be detected and closed.</li><li>It&rsquo;s also worth noting that there&rsquo;s a
<a href="https://www.tornadoweb.org/en/stable/websocket.html?highlight=websocket_max_message_size#tornado.websocket.WebSocketHandler"><code>tornado.websocket.WebSocketHandler.websocket_max_message_size</code></a>
attribute. While this is set to a generous 10 MiB, it&rsquo;s important that the
WebSocket messages don&rsquo;t exceed this limit!</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34; Every 100ms, sample from a Bernoulli and write the value to a WebSocket. &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tornado.ioloop
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tornado.web
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tornado.websocket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebSocketServer</span>(tornado<span style=color:#f92672>.</span>websocket<span style=color:#f92672>.</span>WebSocketHandler):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Simple WebSocket handler to serve clients.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Note that `clients` is a class variable and `send_message` is a</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># classmethod.</span>
</span></span><span style=display:flex><span>    clients <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>open</span>(self):
</span></span><span style=display:flex><span>        WebSocketServer<span style=color:#f92672>.</span>clients<span style=color:#f92672>.</span>add(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_close</span>(self):
</span></span><span style=display:flex><span>        WebSocketServer<span style=color:#f92672>.</span>clients<span style=color:#f92672>.</span>remove(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_message</span>(cls, message: str):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Sending message </span><span style=color:#e6db74>{</span>message<span style=color:#e6db74>}</span><span style=color:#e6db74> to </span><span style=color:#e6db74>{</span>len(cls<span style=color:#f92672>.</span>clients)<span style=color:#e6db74>}</span><span style=color:#e6db74> client(s).&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> client <span style=color:#f92672>in</span> cls<span style=color:#f92672>.</span>clients:
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>write_message(message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RandomBernoulli</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.72</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;True p = </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>p<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sample</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> int(random<span style=color:#f92672>.</span>uniform(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> self<span style=color:#f92672>.</span>p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create a web app whose only endpoint is a WebSocket, and start the web</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># app on port 8888.</span>
</span></span><span style=display:flex><span>    app <span style=color:#f92672>=</span> tornado<span style=color:#f92672>.</span>web<span style=color:#f92672>.</span>Application(
</span></span><span style=display:flex><span>        [(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;/websocket/&#34;</span>, WebSocketServer)],
</span></span><span style=display:flex><span>        websocket_ping_interval<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>        websocket_ping_timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>8888</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create an event loop (what Tornado calls an IOLoop).</span>
</span></span><span style=display:flex><span>    io_loop <span style=color:#f92672>=</span> tornado<span style=color:#f92672>.</span>ioloop<span style=color:#f92672>.</span>IOLoop<span style=color:#f92672>.</span>current()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Before starting the event loop, instantiate a RandomBernoulli and</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># register a periodic callback to write a sampled value to the WebSocket</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># every 100ms.</span>
</span></span><span style=display:flex><span>    random_bernoulli <span style=color:#f92672>=</span> RandomBernoulli()
</span></span><span style=display:flex><span>    periodic_callback <span style=color:#f92672>=</span> tornado<span style=color:#f92672>.</span>ioloop<span style=color:#f92672>.</span>PeriodicCallback(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>lambda</span>: WebSocketServer<span style=color:#f92672>.</span>send_message(str(random_bernoulli<span style=color:#f92672>.</span>sample())), <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    periodic_callback<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Start the event loop.</span>
</span></span><span style=display:flex><span>    io_loop<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></div><h2 id=client>Client</h2><ul><li><code>WebSocketClient</code> is a class that:<ol><li>Can be <code>start</code>ed and <code>stop</code>ped to connect/disconnect to the WebSocket and
start/stop listening to it in a separate thread</li><li>Can process every message (<code>on_message</code>) it hears from the WebSocket: in
this case it simply maintains <a href=https://www.georgeho.org/bayesian-bandits/#stochastic-aka-stationary-bandits>a count of the number of trials and
successes</a>,
but this processing could theoretically be anything. For example, you
could do some further processing of the message and then dump that into a
separate WebSocket for other apps (or even users!) to subscribe to.</li></ol></li><li>To connect to the WebSocket, we need to use a WebSocket library: thankfully
Tornado has a built-in WebSocket functionality (<code>tornado.websocket</code>), but
we&rsquo;re also free to use other libraries such as the creatively named
<a href=https://github.com/aaugustin/websockets><code>websockets</code></a> or
<a href=https://github.com/websocket-client/websocket-client><code>websocket-client</code></a>.</li><li>Note that we run <code>on_message</code> on the same thread as we run
<code>connect_and_read</code>. This isn&rsquo;t a problem so long as <code>on_message</code> is fast
enough, but a potentially wiser choice would be to offload <code>connect_and_read</code>
to a separate thread by instantiating a
<a href=https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor><code>concurrent.futures.ThreadPoolExecutor</code></a>
and calling
<a href=https://www.tornadoweb.org/en/stable/ioloop.html#tornado.ioloop.IOLoop.run_in_executor><code>tornado.ioloop.IOLoop.run_in_executor</code></a>,
so as not to block the thread where the <code>on_message</code> processing happens.</li><li>The <code>io_loop</code> instantiated in <code>main</code> (as well as in <code>server.py</code>) is
important: it&rsquo;s how Tornado schedules tasks (a.k.a. <em>callbacks</em>) for delayed
(a.k.a. <em>asynchronous</em>) execution. To add a callback, we simply call
<code>io_loop.add_callback()</code>.</li><li>The <a href="https://www.tornadoweb.org/en/stable/websocket.html?highlight=ping_#tornado.websocket.websocket_connect"><code>ping_interval</code> and <code>ping_timeout</code> arguments to
<code>websocket_connect</code></a>
configure periodic pings of the WebSocket connection, keeping connections
alive and allowing dropped connections to be detected and closed.</li><li>The <code>callback=self.maybe_retry_connection</code> is <a href=https://github.com/tornadoweb/tornado/blob/1db5b45918da8303d2c6958ee03dbbd5dc2709e9/tornado/websocket.py#L1654-L1655>run on a future
<code>WebSocketClientConnection</code></a>.
<code>websocket_connect</code> doesn&rsquo;t actually establish the connection directly, but
rather returns a future. Hence, we try to get the <code>future.result()</code> itself
(i.e. the WebSocket client connection) &mdash; I don&rsquo;t actually do anything with
the <code>self.connection</code>, but you could if you wanted. In the event of an
exception while doing that, we assume there&rsquo;s a problem with the WebSocket
connection and retry <code>connect_and_read</code> after 3 seconds. This all has the
effect of recovering gracefully if the WebSocket is dropped or <code>server.py</code>
experiences a brief outage for whatever reason (both of which are probably
inevitable for long-running apps using WebSockets).</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34; Stream data from the WebSocket and update the Beta posterior parameters online. &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tornado.ioloop
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tornado.websocket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebSocketClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, io_loop):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>connection <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>io_loop <span style=color:#f92672>=</span> io_loop
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>num_successes <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>num_trials <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>connect_and_read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stop</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>io_loop<span style=color:#f92672>.</span>stop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>connect_and_read</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Reading...&#34;</span>)
</span></span><span style=display:flex><span>        tornado<span style=color:#f92672>.</span>websocket<span style=color:#f92672>.</span>websocket_connect(
</span></span><span style=display:flex><span>            url<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ws://localhost:8888/websocket/&#34;</span>,
</span></span><span style=display:flex><span>            callback<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>maybe_retry_connection,
</span></span><span style=display:flex><span>            on_message_callback<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>on_message,
</span></span><span style=display:flex><span>            ping_interval<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            ping_timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>maybe_retry_connection</span>(self, future) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>connection <span style=color:#f92672>=</span> future<span style=color:#f92672>.</span>result()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Could not reconnect, retrying in 3 seconds...&#34;</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>io_loop<span style=color:#f92672>.</span>call_later(<span style=color:#ae81ff>3</span>, self<span style=color:#f92672>.</span>connect_and_read)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_message</span>(self, message):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> message <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Disconnected, reconnecting...&#34;</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>connect_and_read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> int(message)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>num_successes <span style=color:#f92672>+=</span> message
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>num_trials <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>num_successes
</span></span><span style=display:flex><span>        beta <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>num_trials <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>num_successes
</span></span><span style=display:flex><span>        mean <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>num_successes <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>num_trials
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;α = </span><span style=color:#e6db74>{</span>alpha<span style=color:#e6db74>}</span><span style=color:#e6db74>; β = </span><span style=color:#e6db74>{</span>beta<span style=color:#e6db74>}</span><span style=color:#e6db74>; mean = </span><span style=color:#e6db74>{</span>mean<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create an event loop (what Tornado calls an IOLoop).</span>
</span></span><span style=display:flex><span>    io_loop <span style=color:#f92672>=</span> tornado<span style=color:#f92672>.</span>ioloop<span style=color:#f92672>.</span>IOLoop<span style=color:#f92672>.</span>current()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Before starting the event loop, instantiate a WebSocketClient and add a</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># callback to the event loop to start it. This way the first thing the</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># event loop does is to start the client.</span>
</span></span><span style=display:flex><span>    client <span style=color:#f92672>=</span> WebSocketClient(io_loop)
</span></span><span style=display:flex><span>    io_loop<span style=color:#f92672>.</span>add_callback(client<span style=color:#f92672>.</span>start)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Start the event loop.</span>
</span></span><span style=display:flex><span>    io_loop<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></div><h2 id=why-tornado>Why Tornado?</h2><p>Tornado is a Python web framework, but unlike the more popular Python web
frameworks like <a href=https://flask.palletsprojects.com/>Flask</a> or
<a href=https://www.djangoproject.com/>Django</a>, it has strong support for
<a href=https://www.tornadoweb.org/en/stable/guide/async.html#blocking>asynchronous networking and non-blocking
calls</a> &mdash;
essentially, Tornado apps have one (single-threaded) event loop
(<code>tornado.ioloop.IOLoop</code>), which handles all requests asynchronously,
dispatching incoming requests to the relevant non-blocking function as the
request comes in. As far as I know, Tornado is the only Python web framework
that does this.</p><p>As an aside, Tornado seems to be <a href=https://thehftguy.com/2020/10/27/my-experience-in-production-with-flask-bottle-tornado-and-twisted/>more popular in
finance</a>,
where streaming real-time data (e.g. market data) is very common.</p><h2 id=why-websockets>Why WebSockets?</h2><p>A sharper question might be, why WebSockets over HTTP requests to a REST
endpoint? After all, both theoretically allow a client to stream data in
real-time from a server.</p><p><a href=https://stackoverflow.com/a/45464306>A lot can be said</a> when comparing
WebSockets and RESTful services, but I think the main points are accurately
summarized by <a href=https://www.baeldung.com/rest-vs-websockets#usage>Kumar Chandrakant on
Baeldung</a>:</p><blockquote><p>[A] WebSocket is more suitable for cases where a push-based and real-time
communication defines the requirement more appropriately. Additionally,
WebSocket works well for scenarios where a message needs to be pushed to
multiple clients simultaneously. These are the cases where client and server
communication over RESTful services will find it difficult if not prohibitive.</p></blockquote><p>Tangentially, there&rsquo;s one alternative that seems to be better than WebSockets
from a protocol standpoint, but unfortunately doesn&rsquo;t seem to have support from
many Python web frameworks, and that is <a href=https://www.smashingmagazine.com/2018/02/sse-websockets-data-flow-http2/>Server-Sent Events (a.k.a.
SSE)</a>:
it seems to be a cleaner protocol for unidirectional data flow, which is really
all that we need.</p><p>Additionally, <a href=https://lucumr.pocoo.org/2012/9/24/websockets-101/>Armin
Ronacher</a> has a much
starker view of WebSockets, seeing no value in using WebSockets over TCP/IP
sockets for this application:</p><blockquote><p>Websockets make you sad. [&mldr;] Websockets are complex, way more complex than I
anticipated. I can understand that they work that way but I definitely don&rsquo;t
see a value in using websockets instead of regular TCP connections if all you
want is to exchange data between different endpoints and neither is a browser.</p></blockquote><p>My thought after reading these criticisms is that perhaps WebSockets aren&rsquo;t the
ideal technology for handling streaming data (from a maintainability or
architectural point of view), but that doesn&rsquo;t mean that they aren&rsquo;t good
scalable technologies when they do work.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>There is <a href=https://sqlstream.com/real-time-vs-streaming-a-short-explanation/>technically a difference</a> between &ldquo;real-time&rdquo; and &ldquo;streaming&rdquo;: &ldquo;real-time&rdquo; refers to data that comes in as it is created, whereas &ldquo;streaming&rdquo; refers to a system that processes data continuously. You stream your TV show from Netflix, but since the show was created long before you watched it, you aren&rsquo;t viewing it in real-time.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></content><p><a href=https://www.georgeho.org/blog/python/>#python</a>
<a href=https://www.georgeho.org/blog/streaming/>#streaming</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>